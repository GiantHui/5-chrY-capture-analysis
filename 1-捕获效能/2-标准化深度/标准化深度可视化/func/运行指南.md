# 标准化深度可视化：脚本结构与运行指南

本项目按“计算 → 整理输入 → 绘图”三步拆分。计算与绘图彻底解耦：前两步读取 `conf/config.json`，绘图步骤直接用中间 CSV。

---

## 1. 项目结构（关键脚本）

### 分步运行脚本
- `script/1-均一化计算.sh`
  - 只做计算（生成单样本均一性 + 位置曲线）
- `script/2-可视化输入文件.sh`
  - 整理计算结果，生成 tidyplots 可直接使用的 CSV

### 计算与绘图模块（R）
- `script/2-均一化计算.R`
  - 单样本计算模块（均一性 + 位置曲线）
- `script/2-准备可视化输入.R`
  - 汇总结果 → 生成可视化输入 CSV（参数由 shell 解析后传入）
- `script/3-可视化.R`
  - 读取 CSV → tidyplots 出图 + 英文图注（直接 Rscript 运行）

### 绘图/辅助模块
- `script/arg_utils.R`：轻量参数解析

---

## 2. 配置文件（唯一入口）

配置路径：
```
conf/config.json
```

关键字段：
- `normalized_depth_dir`：输入 normalized depth 文件目录
- `average_depth_csv`：平均深度文件
- `target_intervals_tsv`：靶标区间（bed）
- `visual_input_dir`：可视化中间文件输出目录
- `position_bin_size` / `position_smooth_window` / `gap_multiplier`：平滑参数
- `plot_sample_strategy` / `plot_sample_n` / `plot_random_seed`：位置曲线抽样策略

---

## 3. 输入文件要求

必须有：
- `input/*.normalized.tsv.gz`
  - 每个样本一个文件，列：Chr, Pos, RawDepth, NormDepth
- `input/average_depth.csv`
  - 两列：SampleID, Avg
- `input/7.4m.bed`
  - bed 形式区间（至少 3 列：chr, start, end）

---

## 4. 运行方式

### 标准三步
**1）均一化计算（生成每个样本的均一性 + 位置曲线）**
```bash
bash script/1-均一化计算.sh
```

**2）整理可视化输入（合并为 CSV）**
```bash
bash script/2-可视化输入文件.sh
```

**3）绘图（只依赖 CSV）**
```bash
# 默认使用项目内绝对路径
Rscript script/3-可视化.R
# 或指定输入 / 输出 / tmp 目录
Rscript script/3-可视化.R /path/to/visual_input_csv /path/to/output /path/to/tmp
```

---

## 5. 中间文件（跨语言可用）

计算完成后会生成：
```
<data>/visual_input_csv/
  ├── uniformity_tbl.csv
  ├── position_curve_tbl.csv
  ├── avg_depth_tbl.csv
  ├── selected_samples.csv
  ├── target_intervals.csv
```

这些 CSV 可直接用于服务器与本地之间调试，`3-可视化.R` 仅依赖这些文件。

---

## 6. 输出结果

图像输出目录：
```
output/
```

主要输出：
- `uniformity_avg_scatter.png`
- `uniformity_log_scatter.png`
- `coverage_position_curves.png`

文本解读（自动生成）：
- `output/figure_captions_en.txt`

---

## 7. 常见问题

1. 报错找不到 input 文件：
   - 确认 `input/` 目录下真实存在 normalized depth 文件

2. R 包缺失：
   - 需要安装：`tidyverse`, `patchwork`, `jsonlite`, `ggthemes`

---

如需扩展功能或调整参数，请修改 `conf/config.json` 并按三步流程重新运行。  
